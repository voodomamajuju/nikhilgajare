<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Model Management</title>
  <link rel="stylesheet" href="login.css">
</head>
<body>
  <div class="login-container">
    <h1>Model Management</h1>
    <p class="subtitle">Professional Platform ‚Ä¢ 18+ only</p>
    
    <div class="auth-section">
      <button id="googleSignIn" class="auth-btn google">
        <span class="icon">üîç</span>
        Sign in with Google
      </button>
      
      <div class="divider">
        <span>or</span>
      </div>
      
      <form id="emailForm" class="email-form">
        <input type="email" id="email" placeholder="Enter your email" required pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" title="Please enter a valid email address">
        <input type="password" id="password" placeholder="Enter your password" required>
        <button type="submit" class="auth-btn email">Sign In</button>
      </form>
      
              <div class="auth-links">
                <button id="signUpToggle" class="link-btn">Don't have an account? Sign Up</button>
                <button id="logoutBtn" class="link-btn logout" style="display: none;">Logout & Clear Session</button>
              </div>
    </div>
    
    <div id="status" class="status-message"></div>
  </div>


  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.public.js";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    console.log("‚úÖ Supabase client initialized");
    console.log('supabase auth API:', 
      !!supabase?.auth?.signInWithPassword ? 'v2' : 
      !!supabase?.auth?.signIn ? 'v1' : 
      'unknown'
    );
    
    // Clear any existing session data on login page load
    console.log('üßπ Clearing session data on login page load');
    sessionStorage.removeItem('userRole');

    async function redirectToApp() {
      // For regular users, check if they have an existing submission
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          // Check if user has an existing submission
          const { data: submission, error } = await supabase
            .from('submissions')
            .select('*')
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (submission && !error) {
            console.log('üìã User has existing submission, redirecting to submission details');
            // Redirect to a submission details/edit page
            window.location.href = 'submission-details.html';
                  } else {
                    console.log('üìù No existing submission, redirecting to form');
                    // No existing submission, redirect to form for new users
                    window.location.href = 'form.html';
                  }
        } else {
          // No user, stay on login page
          console.log('üë§ No user session, staying on login page');
        }
      } catch (error) {
        console.error('‚ùå Error checking existing submission:', error);
        // Redirect to form on error as fallback
        console.log('‚ö†Ô∏è Error occurred, redirecting to form as fallback');
        window.location.href = 'form.html';
      }
    }

    function showStatus(message, isError = false) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status-message ${isError ? 'error' : 'success'}`;
      status.style.display = 'block';
    }
    
    // Check if user is already logged in
    const { data: { session } } = await supabase.auth.getSession();
    const urlParams = new URLSearchParams(window.location.search);
    const shouldAuto = urlParams.get('auto') === '1'; // only auto-redirect when explicitly requested
    if (session) {
      // Show logout button for signed-in users
      document.getElementById('logoutBtn').style.display = 'block';
      
      // Only auto-redirect after explicit flows (e.g., OAuth), and not from thank you page
      if (shouldAuto && urlParams.get('from') !== 'thankyou') {
        // Check if this is an admin by email
        const userEmail = session.user.email;
        console.log('üîç Checking user email:', userEmail);
        
        if (userEmail === 'admin@example.com' || userEmail === 'nikhil.dg2003@gmail.com') {
          console.log('üîÑ Admin email detected, redirecting to admin.html');
          sessionStorage.setItem('userRole', 'admin');
          window.location.href = 'admin.html';
        } else {
          console.log('üë§ Regular user detected, checking submission');
          sessionStorage.setItem('userRole', 'user');
          await redirectToApp();
        }
      } else {
        console.log('‚ÑπÔ∏è Session present, staying on login (no auto param).');
      }
    }


    // Listen for auth changes
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('üîç Auth state changed:', event, session?.user?.email);
      if (event === 'SIGNED_IN' && session) {
        console.log('‚úÖ User signed in, redirecting...');
        // Check if this is an admin login by email
        const userEmail = session.user.email;
        if (userEmail === 'admin@example.com' || userEmail === 'nikhil.dg2003@gmail.com') {
          console.log('üîÑ Admin email detected, redirecting to admin.html');
          sessionStorage.setItem('userRole', 'admin');
          window.location.href = 'admin.html';
        } else {
          console.log('üë§ Regular user detected, checking for existing submission');
          sessionStorage.setItem('userRole', 'user');
          await redirectToApp();
        }
      } else if (event === 'SIGNED_OUT') {
        console.log('üëã User signed out');
        // Clear user role on logout
        sessionStorage.removeItem('userRole');
        document.getElementById('logoutBtn').style.display = 'none';
      }
    });


    // Google OAuth
    document.getElementById("googleSignIn").addEventListener("click", async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          // Return with auto=1 to enable single-shot auto-redirect after OAuth only
          redirectTo: window.location.origin + "/login.html?auto=1"
        }
      });
      if (error) {
        showStatus("Google sign-in failed: " + error.message, true);
      }
    });


    // Logout button
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await supabase.auth.signOut();
        sessionStorage.clear();
        localStorage.clear();
        showStatus("Logged out successfully! Session cleared.", false);
        document.getElementById('logoutBtn').style.display = 'none';
        console.log('‚úÖ Logout completed, session cleared');
      } catch (error) {
        console.error('‚ùå Logout error:', error);
        showStatus("Logout failed: " + error.message, true);
      }
    });

    // Sign up/Sign in toggle
    document.getElementById("signUpToggle").addEventListener("click", () => {
      const submitBtn = document.querySelector(".email-form .auth-btn");
      const isCurrentlySignUp = submitBtn.textContent === "Sign Up";
      
      if (isCurrentlySignUp) {
        submitBtn.textContent = "Sign In";
        document.getElementById("signUpToggle").textContent = "Don't have an account? Sign Up";
      } else {
        submitBtn.textContent = "Sign Up";
        document.getElementById("signUpToggle").textContent = "Already have an account? Sign In";
      }
    });

    // Email validation function (same as contact.js)
    function validateEmail(email) {
      if (!email) return { valid: false, message: 'Email is required' };
      
      // Basic format validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        return { valid: false, message: 'Please enter a valid email format' };
      }
      
      // Whitelist of popular, legitimate email domains
      const allowedDomains = [
        // Major email providers
        'gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'live.com',
        'aol.com', 'icloud.com', 'me.com', 'mac.com', 'protonmail.com',
        'yandex.com', 'mail.ru', 'zoho.com', 'fastmail.com',
        
        // Educational institutions (.edu domains)
        'harvard.edu', 'mit.edu', 'stanford.edu', 'berkeley.edu', 'ucla.edu',
        'nyu.edu', 'columbia.edu', 'cornell.edu', 'princeton.edu', 'yale.edu',
        'duke.edu', 'northwestern.edu', 'upenn.edu', 'brown.edu', 'dartmouth.edu',
        'vanderbilt.edu', 'rice.edu', 'wustl.edu', 'emory.edu', 'georgetown.edu',
        'carnegie.edu', 'cmu.edu', 'jhu.edu', 'usc.edu', 'ucsd.edu',
        'ucsb.edu', 'ucdavis.edu', 'uci.edu', 'ucsc.edu', 'ucr.edu',
        'caltech.edu', 'gatech.edu', 'umich.edu', 'illinois.edu', 'purdue.edu',
        'indiana.edu', 'wisconsin.edu', 'minnesota.edu', 'ohio.edu', 'psu.edu',
        'rutgers.edu', 'umd.edu', 'virginia.edu', 'vt.edu', 'ncsu.edu',
        'unc.edu', 'duke.edu', 'wfu.edu', 'clemson.edu', 'sc.edu',
        'uga.edu', 'fsu.edu', 'ufl.edu', 'miami.edu', 'fiu.edu',
        'ut.edu', 'tamu.edu', 'utdallas.edu', 'uh.edu', 'rice.edu',
        'baylor.edu', 'tcu.edu', 'smu.edu', 'ttu.edu', 'utep.edu',
        'asu.edu', 'uofa.edu', 'nau.edu', 'unlv.edu', 'unr.edu',
        'ucolorado.edu', 'csu.edu', 'du.edu', 'colorado.edu', 'utah.edu',
        'byu.edu', 'usu.edu', 'wsu.edu', 'uw.edu', 'oregon.edu',
        'osu.edu', 'pdx.edu', 'uoregon.edu', 'oregonstate.edu', 'alaska.edu',
        'hawaii.edu', 'manoa.edu', 'hilo.edu', 'westoahu.edu', 'kapi.edu',
        
        // International domains
        'gmail.co.uk', 'yahoo.co.uk', 'hotmail.co.uk', 'outlook.co.uk',
        'gmail.ca', 'yahoo.ca', 'hotmail.ca', 'outlook.ca',
        'gmail.com.au', 'yahoo.com.au', 'hotmail.com.au', 'outlook.com.au',
        'gmail.de', 'yahoo.de', 'hotmail.de', 'outlook.de',
        'gmail.fr', 'yahoo.fr', 'hotmail.fr', 'outlook.fr',
        'gmail.it', 'yahoo.it', 'hotmail.it', 'outlook.it',
        'gmail.es', 'yahoo.es', 'hotmail.es', 'outlook.es',
        'gmail.in', 'yahoo.in', 'hotmail.in', 'outlook.in',
        'gmail.co.in', 'yahoo.co.in', 'hotmail.co.in', 'outlook.co.in',
        'rediffmail.com', 'sify.com', 'indiatimes.com', 'vsnl.com',
        'gmail.co.jp', 'yahoo.co.jp', 'hotmail.co.jp', 'outlook.co.jp',
        'gmail.co.kr', 'yahoo.co.kr', 'hotmail.co.kr', 'outlook.co.kr',
        'gmail.com.br', 'yahoo.com.br', 'hotmail.com.br', 'outlook.com.br',
        'gmail.com.mx', 'yahoo.com.mx', 'hotmail.com.mx', 'outlook.com.mx',
        
        // Corporate domains (common ones)
        'microsoft.com', 'apple.com', 'google.com', 'amazon.com', 'facebook.com',
        'twitter.com', 'linkedin.com', 'salesforce.com', 'oracle.com', 'ibm.com',
        'intel.com', 'nvidia.com', 'adobe.com', 'cisco.com', 'vmware.com',
        'netflix.com', 'spotify.com', 'uber.com', 'airbnb.com', 'tesla.com',
        'spacex.com', 'paypal.com', 'stripe.com', 'square.com', 'shopify.com',
        'dropbox.com', 'box.com', 'slack.com', 'zoom.us', 'teams.microsoft.com',
        'github.com', 'gitlab.com', 'bitbucket.org', 'atlassian.com', 'jira.com',
        'trello.com', 'asana.com', 'notion.so', 'figma.com', 'canva.com',
        'mailchimp.com', 'hubspot.com', 'zendesk.com', 'intercom.com', 'freshworks.com',
        'twilio.com', 'sendgrid.com', 'mailgun.com', 'postmark.com', 'mandrill.com',
        
        // Government domains
        'gov.in', 'gov.uk', 'gov.ca', 'gov.au', 'gov.de', 'gov.fr', 'gov.it',
        'gov.es', 'gov.jp', 'gov.kr', 'gov.br', 'gov.mx', 'gov.us', 'gov.com',
        
        // Non-profit organizations
        'org', 'ngo', 'foundation', 'charity', 'un.org', 'who.int', 'unicef.org',
        'redcross.org', 'doctorswithoutborders.org', 'amnesty.org', 'greenpeace.org',
        'wwf.org', 'nature.org', 'sierraclub.org', 'audubon.org', 'nrdc.org'
      ];
      
      const domain = email.split('@')[1]?.toLowerCase();
      
      // Check if domain is in whitelist
      if (!allowedDomains.includes(domain)) {
        return { valid: false, message: 'Invalid email ID' };
      }
      
      return { valid: true, message: 'Email looks good!' };
    }

    // Email/Password authentication
    document.getElementById("emailForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const submitBtnText = document.querySelector(".email-form .auth-btn").textContent;
      const isSignUp = submitBtnText === "Sign Up";

      // Validate email before proceeding
      const emailValidation = validateEmail(email);
      if (!emailValidation.valid) {
        showStatus(`‚ùå ${emailValidation.message}`, 'error');
        return;
      }

      console.log('üîç Auth attempt:', { 
        email, 
        isSignUp, 
        toggleText: document.getElementById("signUpToggle").textContent,
        submitBtnText 
      });

      try {
        if (isSignUp) {
          // Allow sign up for regular users - redirect to main form
          const { data, error } = await supabase.auth.signUp({ email, password });
          if (error) throw error;
          showStatus("Sign up successful! Redirecting to form...");
          
                  // Direct redirect to form.html for sign up
                  setTimeout(() => {
                    console.log('üéâ Sign up completed, redirecting to form.html');
                    window.location.href = 'form.html';
                  }, 1000);
        } else {
          // Sign in - redirect to existing submission or main form
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          showStatus("Sign in successful! Redirecting...");
          // The redirect will be handled by the auth state change listener
        }
      } catch (error) {
        console.error('‚ùå Auth error:', error);
        showStatus("Authentication failed: " + error.message, true);
      }
    });
  </script>
</body>
</html>