<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Model Management</title>
  <link rel="stylesheet" href="login.css">
</head>
<body>
  <div class="login-container">
    <h1>Sign In</h1>
    <p class="subtitle">Access your account</p>
    
    <div class="auth-section">
      <button id="googleSignIn" class="auth-btn google">
        <span class="icon">üîç</span>
        Sign in with Google
      </button>
      
      <div class="divider">
        <span>or</span>
      </div>
      
      <form id="emailForm" class="email-form">
        <input type="email" id="email" placeholder="Enter your email" required>
        <input type="password" id="password" placeholder="Enter your password" required>
        <button type="submit" class="auth-btn email">Sign In</button>
      </form>
      
              <div class="auth-links">
                <button id="signUpToggle" class="link-btn">Don't have an account? Sign Up</button>
                <button id="logoutBtn" class="link-btn logout" style="display: none;">Logout & Clear Session</button>
              </div>
    </div>
    
    <div id="status" class="status-message"></div>
  </div>


  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.public.js";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    console.log("‚úÖ Supabase client initialized");
    console.log('supabase auth API:', 
      !!supabase?.auth?.signInWithPassword ? 'v2' : 
      !!supabase?.auth?.signIn ? 'v1' : 
      'unknown'
    );
    
    // Clear any existing session data on login page load
    console.log('üßπ Clearing session data on login page load');
    sessionStorage.removeItem('userRole');

    async function redirectToApp() {
      // For regular users, check if they have an existing submission
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          // Check if user has an existing submission
          const { data: submission, error } = await supabase
            .from('submissions')
            .select('*')
            .eq('user_id', user.id)
            .maybeSingle();
          
          if (submission && !error) {
            console.log('üìã User has existing submission, redirecting to submission details');
            // Redirect to a submission details/edit page
            window.location.href = 'submission-details.html';
                  } else {
                    console.log('üìù No existing submission, staying on login page');
                    // No existing submission, stay on login page for user to choose
                  }
        } else {
          // No user, stay on login page
          console.log('üë§ No user session, staying on login page');
        }
      } catch (error) {
        console.error('‚ùå Error checking existing submission:', error);
        // Stay on login page on error
        console.log('‚ö†Ô∏è Error occurred, staying on login page');
      }
    }

    function showStatus(message, isError = false) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status-message ${isError ? 'error' : 'success'}`;
      status.style.display = 'block';
    }
    
    // Check if user is already logged in
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      // Show logout button
      document.getElementById('logoutBtn').style.display = 'block';
      
      // Only auto-redirect if not coming from thank you page
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('from') !== 'thankyou') {
        // Check if this is an admin by email
        const userEmail = session.user.email;
        console.log('üîç Checking user email:', userEmail);
        
        if (userEmail === 'admin@example.com' || userEmail === 'nikhil.dg2003@gmail.com') {
          console.log('üîÑ Admin email detected, redirecting to admin.html');
          sessionStorage.setItem('userRole', 'admin');
          window.location.href = 'admin.html';
        } else {
          console.log('üë§ Regular user detected, checking submission');
          sessionStorage.setItem('userRole', 'user');
          await redirectToApp();
        }
      }
    }


    // Listen for auth changes
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('üîç Auth state changed:', event, session?.user?.email);
      if (event === 'SIGNED_IN' && session) {
        console.log('‚úÖ User signed in, redirecting...');
        // Check if this is an admin login by email
        const userEmail = session.user.email;
        if (userEmail === 'admin@example.com' || userEmail === 'nikhil.dg2003@gmail.com') {
          console.log('üîÑ Admin email detected, redirecting to admin.html');
          sessionStorage.setItem('userRole', 'admin');
          window.location.href = 'admin.html';
        } else {
          console.log('üë§ Regular user detected, checking for existing submission');
          sessionStorage.setItem('userRole', 'user');
          await redirectToApp();
        }
      } else if (event === 'SIGNED_OUT') {
        console.log('üëã User signed out');
        // Clear user role on logout
        sessionStorage.removeItem('userRole');
        document.getElementById('logoutBtn').style.display = 'none';
      }
    });


    // Google OAuth
    document.getElementById("googleSignIn").addEventListener("click", async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: window.location.origin + "/login.html"
        }
      });
      if (error) {
        showStatus("Google sign-in failed: " + error.message, true);
      }
    });


    // Logout button
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await supabase.auth.signOut();
        sessionStorage.clear();
        localStorage.clear();
        showStatus("Logged out successfully! Session cleared.", false);
        document.getElementById('logoutBtn').style.display = 'none';
        console.log('‚úÖ Logout completed, session cleared');
      } catch (error) {
        console.error('‚ùå Logout error:', error);
        showStatus("Logout failed: " + error.message, true);
      }
    });

    // Sign up/Sign in toggle
    document.getElementById("signUpToggle").addEventListener("click", () => {
      const submitBtn = document.querySelector(".email-form .auth-btn");
      const isCurrentlySignUp = submitBtn.textContent === "Sign Up";
      
      if (isCurrentlySignUp) {
        submitBtn.textContent = "Sign In";
        document.getElementById("signUpToggle").textContent = "Don't have an account? Sign Up";
      } else {
        submitBtn.textContent = "Sign Up";
        document.getElementById("signUpToggle").textContent = "Already have an account? Sign In";
      }
    });

    // Email/Password authentication
    document.getElementById("emailForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const submitBtnText = document.querySelector(".email-form .auth-btn").textContent;
      const isSignUp = submitBtnText === "Sign Up";

      console.log('üîç Auth attempt:', { 
        email, 
        isSignUp, 
        toggleText: document.getElementById("signUpToggle").textContent,
        submitBtnText 
      });

      try {
        if (isSignUp) {
          // Allow sign up for regular users - redirect to main form
          const { data, error } = await supabase.auth.signUp({ email, password });
          if (error) throw error;
          showStatus("Sign up successful! Redirecting to form...");
          
                  // Direct redirect to form.html for sign up
                  setTimeout(() => {
                    console.log('üéâ Sign up completed, redirecting to form.html');
                    window.location.href = 'form.html';
                  }, 1000);
        } else {
          // Sign in - redirect to existing submission or main form
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          showStatus("Sign in successful! Redirecting...");
          // The redirect will be handled by the auth state change listener
        }
      } catch (error) {
        console.error('‚ùå Auth error:', error);
        showStatus("Authentication failed: " + error.message, true);
      }
    });
  </script>
</body>
</html>