<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pictures Upload</title>

  <!-- Fonts + CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@500;700&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <!-- Supabase SDK (defer so it loads before our init) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
</head>
<body>
  <main class="page">
    <section class="card" aria-labelledby="title">
      <header class="header">
        <h1 id="title" class="title">Pictures with Glam Makeup</h1>
        <p class="subtitle">Do you do Glam Makeup?</p>
      </header>

      <form id="glamForm" class="form" enctype="multipart/form-data" novalidate>
        <div class="field">
          <div class="options">
            <label class="checkbox-label">
              <input type="radio" id="glamYes" name="glam_makeup" value="yes" required>
              <span class="custom-checkbox"></span>
              Yes
            </label>

            <label class="checkbox-label">
              <input type="radio" id="glamNo" name="glam_makeup" value="no">
              <span class="custom-checkbox"></span>
              No
            </label>
          </div>
        </div>

        <!-- Uploads (hidden until YES selected) -->
        <div id="glam-upload" class="field hidden" aria-hidden="true">
          <label for="makeup-pics" class="label">Upload your glam photos</label>
          <input id="makeup-pics" name="makeup_pics" type="file" accept="image/jpeg,image/png" multiple class="input" disabled />
          <small id="upload-note" class="note"></small>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button type="submit" id="submitBtn" class="btn">Save & Submit</button>
        </div>
      </form>
    </section>
  </main>

  <script>
    // --------- UI toggle for YES/NO ----------
    const glamYes = document.getElementById('glamYes');
    const glamNo = document.getElementById('glamNo');
    const uploadBlock = document.getElementById('glam-upload');
    const fileInput = document.getElementById('makeup-pics');
    const uploadNote = document.getElementById('upload-note');
    const submitBtn = document.getElementById('submitBtn');

    function updateGlam() {
      if (glamYes.checked) {
        uploadBlock.classList.remove('hidden');
        uploadBlock.setAttribute('aria-hidden', 'false');
        fileInput.disabled = false;
        fileInput.required = true;
      } else {
        uploadBlock.classList.add('hidden');
        uploadBlock.setAttribute('aria-hidden', 'true');
        fileInput.disabled = true;
        fileInput.required = false;
        fileInput.value = ''; // clear
      }
    }

    glamYes.addEventListener('change', updateGlam);
    glamNo.addEventListener('change', updateGlam);
    document.addEventListener('DOMContentLoaded', () => {
      updateGlam();
      if (uploadNote) uploadNote.textContent = 'Up to 5 images • JPG/PNG • Max 5MB each';
    });
  </script>

  <!-- ------- Supabase init + submit handler ------- -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 1) Create or reuse a single global supabase client
      const SUPABASE_URL = 'https://jjsimjaismmwmxjhnmlz.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impqc2ltamFpc21td214amhubWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NDM2NjIsImV4cCI6MjA3MjMxOTY2Mn0.zIUfmYhdPgaHxybM10IfSemXwUWAv7SUstqD-Yf38bE'; // <-- replace locally with your anon key

      if (typeof window.supabase === 'undefined') {
        console.warn('Supabase SDK missing. Check script tag.');
        return;
      }

      if (!window.supabaseClient) {
        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('✅ Global Supabase client created');
      } else {
        console.log('ℹ️ Reusing global Supabase client');
      }

      const supabaseClient = window.supabaseClient;
      const glamForm = document.getElementById('glamForm');

      // constants for validation
      const MAX_FILES = 5;
      const MAX_SIZE_MB = 5;
      const MAX_BYTES = MAX_SIZE_MB * 1024 * 1024;
      const ALLOWED_EXT = /\.(jpe?g|png)$/i;
      const BUCKET_NAME = 'uploads'; // ensure this bucket exists in Supabase

      // helper: set button state
      function setLoading(on) {
        submitBtn.disabled = on;
        submitBtn.textContent = on ? 'Submitting…' : 'Save & Submit';
      }

      // submit handler
      glamForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        setLoading(true);
        console.clear();
        console.log('▶️ Submit clicked');

        try {
          // load saved contact+measure data from localStorage
          const saved = JSON.parse(localStorage.getItem('formData') || '{}');

          // read form data
          const fd = new FormData(glamForm);
          const glamChoice = fd.get('glam_makeup') === 'yes';

          // files
          const files = fd.getAll('makeup_pics').filter(f => f && f.size);
          console.log('Files selected:', files.length);

          // validate files if glam yes
          if (glamChoice) {
            if (files.length === 0) {
              // Ask user to either upload or confirm they want to proceed without photos
              if (!confirm('You selected "Yes" for Glam Makeup but did not choose any images. Continue without photos?')) {
                setLoading(false);
                return;
              }
            }

            if (files.length > MAX_FILES) throw new Error(`You can upload up to ${MAX_FILES} images.`);

            for (const f of files) {
              if (!ALLOWED_EXT.test(f.name)) throw new Error(`File type not allowed: ${f.name}`);
              if (f.size > MAX_BYTES) throw new Error(`File ${f.name} exceeds ${MAX_SIZE_MB}MB.`);
            }
          }

          // upload files (if any)
          const paths = [];
          if (files.length > 0) {
            for (const f of files) {
              const safeName = f.name.replace(/\s+/g, '_').replace(/[^\w\-.]/g, '');
              const key = `submissions/${Date.now()}_${Math.random().toString(36).slice(2,8)}_${safeName}`;
              console.log('⬆️ Uploading', f.name, '->', key);

              const { data, error } = await supabaseClient.storage.from(BUCKET_NAME).upload(key, f, {
                cacheControl: '3600',
                upsert: false
              });

              if (error) {
                console.error('Upload error', error);
                throw new Error(error.message || 'Upload failed');
              }

              paths.push(data.path);
            }
            console.log('Uploaded paths:', paths);
          }

          // merge saved + glam + paths
          Object.assign(saved, {
            glam_makeup: glamChoice,
            photo_paths: paths
          });

          // Insert into DB (submissions table)
          const { data: insertData, error: insertErr } = await supabaseClient.from('submissions').insert(saved).select();
          if (insertErr) {
            console.error('Insert error', insertErr);
            throw new Error(insertErr.message || 'Save failed');
          }

          // success
          localStorage.removeItem('formData');
          alert('✅ Saved! Redirecting to thank you page.');
          window.location.href = 'thankyou.html';
        } catch (err) {
          console.error('Submit error', err);
          alert('Error: ' + (err.message || JSON.stringify(err)));
        } finally {
          setLoading(false);
        }
      });
    });
    
  </script>
</body>
</html>
